generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  name            String?
  email           String?          @unique
  emailVerified   DateTime?
  image           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  accounts        Account[]
  sessions        Session[]
  subscription    Subscription?
  masterProfile   MasterProfile?
  batches         Batch[]
  jobDescriptions JobDescription[]
  resumes         TailoredResume[]
  generationJobs  GenerationJob[]

  @@map("users")
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeCustomerId String?
  stripeSubId      String?
  status           String
  currentPeriodEnd DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model MasterProfile {
  id          String       @id @default(cuid())
  userId      String       @unique
  headline    String?
  summary     String?
  location    String?
  rawText     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  experiences Experience[]
  projects    Project[]
  educations  Education[]
  skills      Skill[]
  links       Link[]
  achievements Achievement[]
  user        User         @relation(fields: [userId], references: [id])

  @@map("master_profiles")
}

model Experience {
  id              String        @id @default(cuid())
  masterProfileId String
  company         String
  title           String
  location        String?
  startDate       DateTime?
  endDate         DateTime?
  bullets         String[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("experiences")
}

model Project {
  id              String        @id @default(cuid())
  masterProfileId String
  name            String
  stack           String?
  bullets         String[]
  links           String[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("projects")
}

model Education {
  id              String        @id @default(cuid())
  masterProfileId String
  school          String
  degree          String?
  field           String?
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("educations")
}

model Skill {
  id              String        @id @default(cuid())
  masterProfileId String
  name            String
  category        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("skills")
}

model Link {
  id              String        @id @default(cuid())
  masterProfileId String
  label           String
  url             String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("links")
}

model Achievement {
  id              String        @id @default(cuid())
  masterProfileId String
  title           String
  description     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  masterProfile   MasterProfile @relation(fields: [masterProfileId], references: [id])

  @@map("achievements")
}

model Batch {
  id          String           @id @default(cuid())
  userId      String
  title       String
  status      String           @default("draft")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?
  jobDescriptions JobDescription[]
  resumes     TailoredResume[]
  user        User             @relation(fields: [userId], references: [id])

  @@map("batches")
}

model JobDescription {
  id          String           @id @default(cuid())
  userId      String
  batchId     String
  company     String?
  role        String?
  location    String?
  text        String
  keywords    String[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?
  batch       Batch            @relation(fields: [batchId], references: [id])
  user        User             @relation(fields: [userId], references: [id])
  resumes     TailoredResume[]
  generationJobs GenerationJob[]

  @@map("job_descriptions")
}

model TailoredResume {
  id              String                 @id @default(cuid())
  userId          String
  jobDescriptionId String
  batchId         String
  templateStyle   String
  status          String                 @default("draft")
  matchScore      Int?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  deletedAt       DateTime?
  versions        TailoredResumeVersion[]
  exportArtifacts ExportArtifact[]
  jobDescription  JobDescription         @relation(fields: [jobDescriptionId], references: [id])
  batch           Batch                  @relation(fields: [batchId], references: [id])
  user            User                   @relation(fields: [userId], references: [id])

  @@map("tailored_resumes")
}

model TailoredResumeVersion {
  id          String         @id @default(cuid())
  resumeId    String
  version     Int
  contentJson Json
  createdAt   DateTime       @default(now())
  resume      TailoredResume @relation(fields: [resumeId], references: [id])

  @@map("tailored_resume_versions")
}

model GenerationJob {
  id              String         @id @default(cuid())
  userId          String
  jobDescriptionId String
  status          String         @default("queued")
  progress        Int            @default(0)
  error           String?
  payload         Json
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id])
  jobDescription  JobDescription @relation(fields: [jobDescriptionId], references: [id])

  @@map("generation_jobs")
}

model ExportArtifact {
  id        String         @id @default(cuid())
  resumeId  String
  type      String
  url       String
  createdAt DateTime       @default(now())
  resume    TailoredResume @relation(fields: [resumeId], references: [id])

  @@map("export_artifacts")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
